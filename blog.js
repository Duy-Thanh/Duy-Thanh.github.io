function getQueryParams(){var e=window.location.search,t={};"?"===e.charAt(0)&&(e=e.substring(1));for(var n=e.split("&"),o=0;o<n.length;o++){var a=n[o].split("=");t[decodeURIComponent(a[0])]=decodeURIComponent(a[1]||"")}return t}function checkAuthStatus(){var e=new XMLHttpRequest;e.open("GET",root_url+"/api/check-auth",!0),e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){var t=JSON.parse(e.responseText),n=document.getElementById("userStatus"),o=document.getElementById("postSection"),a=document.getElementById("loginBtn"),i=document.getElementById("logoutBtn");!0===t.isAuthenticated?(n.textContent="Administrator",o&&(o.style.display="block"),a&&(a.style.display="none"),i&&(i.style.display="inline-block"),loadPosts()):(n.textContent="",o&&(o.style.display="none"),a&&(a.style.display="inline-block",a.onclick=function(){window.location.href="/login.html?redirect=blog"}),i&&(i.style.display="none"),loadPosts())}},e.send()}function loadPosts(){var e=new XMLHttpRequest;e.open("GET",root_url+"/api/posts",!0),e.onreadystatechange=function(){4===e.readyState&&200===e.status&&displayPosts(JSON.parse(e.responseText))},e.send()}function displayPosts(e){var t=document.getElementById("postList");t.innerHTML="";for(var n=0;n<e.length;n++){var o=e[n],a=document.createElement("div");a.className="post-item";var i=document.createElement("h3");i.className="post-title",i.textContent=o.title;var r=document.createElement("div");r.className="post-preview";var l=document.createElement("div");l.innerHTML=o.content;var d=l.textContent||l.innerText;(d=d.replace(/\s+/g," ").replace(/\n+/g," ").trim()).length>200&&(d=d.substring(0,200)+"..."),r.textContent=d;var c=document.createElement("div");c.className="post-meta",c.innerHTML="Posted: "+formatDateTime(o.created)+(o.modified&&o.modified!==o.created?"<br>Last Modified: "+formatDateTime(o.modified):"");var s=document.createElement("a");s.href="/post.html?id="+o.id,s.className="read-more-btn",s.textContent="Read More",a.appendChild(i),a.appendChild(r),a.appendChild(c),a.appendChild(s),t.appendChild(a)}}function formatDateTime(e){var t=new Date(e);return t.toLocaleDateString()+" "+t.toLocaleTimeString()}function editPost(e){window.location.href="/blog.html?action=edit&id="+e.id}function deletePost(e){var t=new XMLHttpRequest;t.open("DELETE",root_url+"/api/posts/"+e,!0),t.onload=function(){200===t.status?loadPosts():alert("Delete failed: "+t.statusText)},t.send()}function logout(){var e=new XMLHttpRequest;e.open("POST",root_url+"/api/logout",!0),e.onreadystatechange=function(){4===e.readyState&&(200===e.status?(document.cookie="",window.location.href="/"):alert("Logout failed: "+e.statusText))},e.send()}function loadPostForEdit(e){var t=new XMLHttpRequest;t.open("GET",root_url+"/api/posts/"+e,!0),t.onreadystatechange=function(){if(4===t.readyState&&200===t.status)try{var n=JSON.parse(t.responseText);document.getElementById("titleInput").value=n.title;var o=document.getElementById("contentInput");o.innerHTML=n.content;var a=document.getElementById("editorTitle");if(a&&(a.textContent="Edit Post"),"undefined"!=typeof Prism)for(var i=o.querySelectorAll("pre code"),r=0;r<i.length;r++)Prism.highlightElement(i[r]);var l=document.getElementById("postSection");l&&(l.style.display="block");var d=document.getElementById("postForm");d&&(d.onsubmit=function(t){t.preventDefault(),updatePost(e)})}catch(e){console.error("Error parsing post data:",e),alert("Error loading post data")}else 4===t.readyState&&(console.error("Failed to load post:",t.statusText),alert("Failed to load post for editing"))},t.onerror=function(){console.error("Network error occurred"),alert("Network error occurred while loading post")},t.send()}function updatePost(e){var t=document.getElementById("titleInput").value.trim(),n=document.getElementById("contentInput").innerHTML;if(n=cleanupContent(n),t&&n){var o=new XMLHttpRequest;o.open("PUT",root_url+"/api/posts/"+e,!0),o.setRequestHeader("Content-Type","application/json"),o.onload=function(){200===o.status?window.location.href="/blog.html":(console.error("Server response:",o.responseText),alert("Update failed: "+o.statusText))},o.onerror=function(){console.error("Network error occurred"),alert("Network error occurred")},o.send(JSON.stringify({title:t,content:n}))}else alert("Please fill in both title and content")}function formatText(e){document.execCommand(e,!1,null)}function submitPost(e){e.preventDefault();var t=document.getElementById("titleInput").value.trim(),n=document.getElementById("contentInput"),o=n?n.innerHTML.trim():"";if(console.log("Title:",t),console.log("Content:",o),t&&o){var a=new XMLHttpRequest;a.open("POST",root_url+"/api/posts",!0),a.setRequestHeader("Content-Type","application/json");var i={title:t,content:o};console.log("Sending post data:",i),a.onload=function(){200===a.status?window.location.href="/blog.html":(console.error("Server response:",a.responseText),alert("Post failed: "+a.statusText))},a.send(JSON.stringify(i))}else alert("Please fill in both title and content")}function insertCode(){var e=window.getSelection().getRangeAt(0),t=e.toString();if(t){var n=document.createElement("div");n.className="code-language-modal",n.innerHTML='<div class="modal-content"><h4>Select Programming Language</h4><select class="language-select"><option value="">Select language...</option><option value="javascript">JavaScript</option><option value="python">Python</option><option value="java">Java</option><option value="cpp">C++</option><option value="csharp">C#</option><option value="php">PHP</option><option value="ruby">Ruby</option><option value="html">HTML</option><option value="css">CSS</option><option value="sql">SQL</option></select><div class="modal-buttons"><button class="ok-btn">OK</button><button class="cancel-btn">Cancel</button></div></div>',document.body.appendChild(n);var o=n.querySelector(".language-select");n.querySelector(".ok-btn").onclick=function(){var a=o.value;if(a){var i=document.createElement("pre");i.className="line-numbers";var r=document.createElement("code");r.className="language-"+a;var l=t.replace(/\r\n/g,"\n").replace(/\n/g,"\n").replace(/\t/g,"    ");r.textContent=l,i.appendChild(r),e.deleteContents(),e.insertNode(i);var d=document.createElement("br");i.parentNode.insertBefore(d,i.nextSibling),Prism.highlightElement(r),document.body.removeChild(n)}else alert("Please select a language")},n.querySelector(".cancel-btn").onclick=function(){document.body.removeChild(n)}}else alert("Please select some text first")}function insertImage(){const e=prompt("Enter image URL:");if(!e)return;const t=document.createElement("img");t.src=e,t.alt="Image";document.getElementById("contentInput");window.getSelection().getRangeAt(0).insertNode(t)}function insertVideo(){var e=prompt("Enter video URL (YouTube or direct video file):");if(e){var t;if(e.includes("youtube.com")||e.includes("youtu.be")){var n=e.split("v=")[1]||e.split("/").pop();(t=document.createElement("iframe")).src="https://www.youtube.com/embed/"+n,t.width="560",t.height="315",t.frameBorder="0",t.allowFullscreen=!0}else(t=document.createElement("video")).src=e,t.controls=!0,t.width="560";window.getSelection().getRangeAt(0).insertNode(t)}}function insertAudio(){const e=prompt("Enter audio URL:");if(!e)return;const t=document.createElement("audio");t.src=e,t.controls=!0;window.getSelection().getRangeAt(0).insertNode(t)}window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),window.onload=function(){checkAuthStatus();var e=getQueryParams(),t=e.action,n=e.id;if("edit"===t&&n){loadPostForEdit(n);var o=document.querySelector(".posts-section");o&&(o.style.display="none")}else loadPosts()};var currentMediaType="image";function openFileModal(e){currentMediaType=e,document.getElementById("fileModal").style.display="flex";var t=document.getElementById("mediaFileInput");if(t)switch(e){case"image":t.accept="image/*";break;case"video":t.accept="video/*";break;case"audio":t.accept="audio/*"}updateModalTitle(),setTimeout((function(){loadMediaFiles()}),100)}function closeFileModal(){var e=document.getElementById("fileModal");if(e){e.style.display="none";var t=document.getElementById("mediaFileList");t&&(t.innerHTML="")}}function loadMediaFiles(){var e=new XMLHttpRequest;e.open("GET",root_url+"/api/files",!0),e.onload=function(){if(200===e.status)try{displayMediaFiles(JSON.parse(e.responseText))}catch(e){console.error("Error parsing files:",e),document.getElementById("mediaFileList").innerHTML="Error loading files"}else document.getElementById("mediaFileList").innerHTML="Error loading files"},e.onerror=function(){document.getElementById("mediaFileList").innerHTML="Error loading files"},e.send()}function displayMediaFiles(e){var t=document.getElementById("mediaFileList");t&&(t.innerHTML='<div class="loading">Loading '+currentMediaType+" files...</div>",e=e.filter((function(e){if(0!==e.name.indexOf("blog_media_"))return!1;switch(currentMediaType){case"image":return e.name.match(/\.(jpg|jpeg|png|gif|ico|bmp|webp)$/i);case"video":return e.name.match(/\.(mp4|webm|ogg|mov|avi)$/i);case"audio":return e.name.match(/\.(mp3|wav|ogg|m4a)$/i);default:return!1}})),t.innerHTML="",0!==e.length?e.forEach((function(e){var n=document.createElement("div");n.className="media-item";var o=document.createElement("div");if(o.className="media-preview-container","image"===currentMediaType){var a=document.createElement("img");a.src=root_url+"/api/files/download/"+e.name,a.className="media-preview",a.alt=e.name.replace("blog_media_",""),o.appendChild(a)}else if("video"===currentMediaType){var i=document.createElement("video");i.src=root_url+"/api/files/download/"+e.name,i.className="media-preview",o.appendChild(i)}else if("audio"===currentMediaType){var r=document.createElement("i");r.className="fas fa-music media-preview-icon",o.appendChild(r)}var l=document.createElement("div");l.className="media-name",l.textContent=e.name.replace("blog_media_",""),n.appendChild(o),n.appendChild(l),n.addEventListener("click",(function(){insertMediaFile(e)})),t.appendChild(n)})):t.innerHTML='<div class="no-files">No '+currentMediaType+" files found</div>")}function insertMediaFile(e){var t=document.getElementById("contentInput");if(t){var n=null,o=root_url+"/api/files/download/"+e.name;if(e.name.match(/\.(jpg|jpeg|png|gif|ico|bmp|webp)$/i)?((n=document.createElement("img")).src=o,n.alt=e.name.replace("blog_media_",""),n.className="media-content"):e.name.match(/\.(mp4|webm|ogg|mov|avi)$/i)?((n=document.createElement("video")).src=o,n.controls=!0,n.className="media-content"):e.name.match(/\.(mp3|wav|ogg|m4a)$/i)&&((n=document.createElement("audio")).src=o,n.controls=!0,n.className="media-content"),!n)return console.error("Could not create element for file:",e),void alert("Unsupported file type. Please use image, video, or audio files.");var a,i=window.getSelection();try{a=i.getRangeAt(0)}catch(e){(a=document.createRange()).selectNodeContents(t),a.collapse(!1),i.removeAllRanges(),i.addRange(a)}n instanceof HTMLImageElement?(n.onload=r,n.onerror=function(){console.error("Failed to load image:",o),alert("Failed to load image file")}):n instanceof HTMLVideoElement?(n.onloadedmetadata=r,n.onerror=function(){console.error("Failed to load video:",o),alert("Failed to load video file")}):r()}function r(){a.insertNode(n);var e=document.createElement("br");(a=document.createRange()).setStartAfter(n),a.collapse(!0),a.insertNode(e),a.setStartAfter(e),a.collapse(!0),i.removeAllRanges(),i.addRange(a),closeFileModal()}}function updateModalTitle(){var e=document.querySelector(".modal-header h3");e&&(e.textContent=currentMediaType.charAt(0).toUpperCase()+currentMediaType.slice(1)+" Files")}function cleanupContent(e){var t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll("pre code").forEach((function(e){e.className.includes("language-")||(e.className="language-plaintext"),e.textContent=e.textContent.replace(/\u200B/g,"").replace(/\u00A0/g," ")})),t.querySelectorAll("pre").forEach((function(e){e.className.includes("line-numbers")||(e.className="line-numbers")})),t.innerHTML}document.addEventListener("DOMContentLoaded",(function(){var e=document.getElementById("mediaFileInput");e&&(e.onchange=function(e){var t=e.target.files[0]?e.target.files[0].name:"No file chosen";document.querySelector(".file-name-display").textContent=t});var t=document.getElementById("mediaUploadForm");t&&(t.onsubmit=function(e){e.preventDefault();var t=document.getElementById("mediaFileInput");if(t.files[0]){var n=new FormData;n.append("file",t.files[0]);var o=new XMLHttpRequest;o.open("POST",root_url+"/api/blog-media/upload",!0),o.onload=function(){if(200===o.status){var e=JSON.parse(o.responseText);e.success?(t.value="",document.querySelector(".file-name-display").textContent="No file chosen",insertMediaFile({name:e.filename}),loadMediaFiles()):alert("Upload failed: "+(e.message||"Unknown error"))}else alert("Upload failed: "+o.statusText)},o.onerror=function(){alert("Upload failed: Network Error")},o.send(n)}else alert("Please select a file first")})})),document.addEventListener("DOMContentLoaded",(function(){var e=document.getElementById("contentInput");e&&(e.addEventListener("input",(function(){for(var e=this.querySelectorAll("pre code"),t=0;t<e.length;t++)Prism.highlightElement(e[t])})),e.addEventListener("paste",(function(e){var t;if(e.preventDefault(),t=window.clipboardData&&window.clipboardData.getData?window.clipboardData.getData("Text"):e.clipboardData&&e.clipboardData.getData?e.clipboardData.getData("text/plain"):"",document.selection)(n=document.selection.createRange()).text=t;else if(window.getSelection){var n;(n=window.getSelection().getRangeAt(0)).deleteContents(),n.insertNode(document.createTextNode(t))}})))}));
