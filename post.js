let clientIp=null,isPolling=!1,isAdmin=!1,lastPostData=null;const POLL_INTERVAL=3e3;let pollTimeoutId=null;function refreshHighlighting(){hljs.configure({ignoreUnescapedHTML:!0}),document.querySelectorAll("pre code").forEach((e=>{e.removeAttribute("data-highlighted"),hljs.highlightElement(e)}))}function getPostId(){var e=window.location.search,t={};"?"===e.charAt(0)&&(e=e.substring(1));for(var o=e.split("&"),n=0;n<o.length;n++){var i=o[n].split("=");t[decodeURIComponent(i[0])]=decodeURIComponent(i[1]||"")}return t.id}function getClientIp(){fetch(`${root_url}/api/client-ip`,{method:"GET",credentials:"include"}).then((e=>e.json())).then((e=>{clientIp=e.ip})).catch((e=>console.error("Error getting client IP:",e)))}function loadPost(){const e=getPostId();e?checkAuthStatus().then((()=>{fetch(`${root_url}/api/posts/${e}`,{credentials:"include"}).then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()})).then((e=>{displayPost(e)})).catch((e=>{console.error("Error:",e),displayError("Failed to load post: "+e.message)}))})):displayError("No post ID specified")}function displayPost(e){if(!e||!e.title||!e.content)return void displayError("Invalid post data");document.title=e.title+" - Blog Post",document.getElementById("postTitle").textContent=e.title,document.getElementById("postContent").innerHTML=e.content,refreshHighlighting();var t=document.getElementById("postMeta");t&&(t.innerHTML="Posted: "+formatDateTime(e.created)+(e.modified?"<br>Last Modified: "+formatDateTime(e.modified):""));["like","heart","star"].forEach((t=>{const o=document.querySelector(`[data-reaction="${t}"]`),n=document.getElementById(`${t}Count`);o&&n&&(n.textContent=e[t+"s"]||0,clientIp&&e.reactions?.[t]?.[clientIp]?o.classList.add("active"):o.classList.remove("active"))}));const o=document.getElementById("commentsList");if(o&&e.comments){const t=e.comments.length>0?e.comments.map((e=>`\n                <div class="comment" data-comment-id="${e.id}">\n                    <div class="comment-header">\n                        <div class="comment-author">${e.author||"Anonymous"}</div>\n                        <div class="comment-date">${formatDateTime(e.created)}</div>\n                        ${e.deleted?'<div class="comment-deleted">This comment has been deleted by administrator</div>':`<div class="comment-content">${e.content}</div>`}\n                    </div>\n                    ${isAdmin&&!e.deleted?`<div class="comment-actions admin-only"><button onclick="deleteComment('${e.id}')"class="btn btn-danger btn-sm"><i class="fas fa-trash"></i>Delete</button></div>`:""}\n                </div>\n            `)).join(""):'<div class="no-comments">No comments yet</div>';o.innerHTML=t}document.querySelectorAll(".admin-only").forEach((e=>{e.style.display=isAdmin?"flex":"none"})),lastPostData=e}function checkAuthStatus(){return fetch(`${root_url}/api/check-auth`,{credentials:"include"}).then((e=>e.json())).then((e=>{isAdmin=e.isAuthenticated&&!e.isGuest;const t=document.getElementById("userStatus");return t&&(t.textContent=isAdmin?"Administrator":"Not logged in"),document.querySelectorAll(".admin-only").forEach((e=>{e.style.display=isAdmin?"flex":"none"})),isAdmin||document.querySelectorAll(".admin-only button").forEach((e=>{e.onclick=null})),e})).catch((e=>{console.error("Auth status error:",e),isAdmin=!1,document.querySelectorAll(".admin-only").forEach((e=>{e.style.display="none"}))}))}function formatDateTime(e){var t=new Date(e);return t.toLocaleDateString()+" "+t.toLocaleTimeString()}function editPost(){var e=getPostId();window.location.href="/blog.html?action=edit&id="+e}function deletePost(){const e=getPostId();confirm("Are you sure you want to delete this post?")&&fetch(`${root_url}/api/posts/${e}`,{method:"DELETE",credentials:"include"}).then((e=>{if(!e.ok)throw new Error("Delete failed");window.location.href="/blog.html"})).catch((e=>{console.error("Error:",e),showModal("Delete failed: "+e.message,"Error","error")}))}function displayError(e){document.title="Error - Blog Post",document.getElementById("postTitle").textContent="Error",document.getElementById("postContent").textContent=e,document.getElementById("postMeta").textContent="";[".reactions-section",".comments-section",".admin-only"].forEach((e=>{document.querySelectorAll(e).forEach((e=>e.style.display="none"))}))}function logout(){fetch(`${root_url}/api/logout`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}}).then((e=>{document.cookie.split(";").forEach((function(e){document.cookie=e.replace(/^ +/,"").replace(/=.*/,"=;expires="+(new Date).toUTCString()+";path=/")})),window.location.href="/"})).catch((e=>{console.error("Logout error:",e),window.location.href="/"}))}function handleReaction(e){if(document.querySelector(`[data-reaction="${e}"]`).classList.contains("disabled"))return void showModal("Please wait before reacting again","Notice","info");document.querySelectorAll(".reaction-btn").forEach((e=>e.classList.add("disabled")));const t=getPostId();fetch(`${root_url}/api/posts/${t}/reactions`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({type:e})}).then((e=>{if(!e.ok)throw new Error("Failed to add reaction");return e.json()})).then((e=>{Object.entries(e.userReactions).forEach((([t,o])=>{const n=document.querySelector(`[data-reaction="${t}"]`);n&&n.classList.toggle("active",o);const i=document.getElementById(`${t}Count`);i&&(i.textContent=e[t+"s"]||0)}))})).catch((e=>{console.error("Reaction error:",e),showModal("Failed to add reaction","Error","error")})).finally((()=>{document.querySelectorAll(".reaction-btn").forEach((e=>e.classList.remove("disabled")))}))}function submitComment(){const e=getPostId(),t=document.getElementById("commentInput").value,o=document.getElementById("commentName").value;t.trim()?fetch(`${root_url}/api/posts/${e}/comments`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({content:t.trim(),author:o.trim()||"Anonymous"})}).then((e=>{if(!e.ok)throw new Error("Failed to post comment");return e.json()})).then((()=>{document.getElementById("commentInput").value="",document.getElementById("commentName").value="",loadPost(),showModal("Comment posted successfully!","Success","success")})).catch((e=>{console.error("Comment error:",e),showModal("Failed to post comment","Error","error")})):showModal("Please write a comment","Notice","warning")}function startPolling(){isPolling||(isPolling=!0,pollForUpdates())}function stopPolling(){isPolling=!1,pollTimeoutId&&(clearTimeout(pollTimeoutId),pollTimeoutId=null)}function pollForUpdates(){if(!isPolling)return;const e=getPostId();e&&fetch(`${root_url}/api/posts/${e}`,{credentials:"include"}).then((e=>{if(404===e.status)return showModal("This post has been deleted","Post Deleted","warning"),void setTimeout((()=>{window.location.href="/blog.html"}),2e3);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()})).then((e=>{e&&hasContentChanged(e)&&(displayPost(e),lastPostData=e)})).catch((e=>{if(console.error("Polling error:",e),e.message.includes("404"))return showModal("This post has been deleted","Post Deleted","warning"),void setTimeout((()=>{window.location.href="/blog.html"}),2e3)})).finally((()=>{isPolling&&(pollTimeoutId=setTimeout(pollForUpdates,3e3))}))}function hasContentChanged(e){if(!lastPostData)return!0;if(!e)return!0;const t=["likes","hearts","stars"].some((t=>e[t]!==lastPostData[t])),o=JSON.stringify(e.comments)!==JSON.stringify(lastPostData.comments);return t||o}function updateReactionsAndComments(e){["like","heart","star"].forEach((t=>{const o=document.querySelector(`[data-reaction="${t}"]`),n=document.getElementById(`${t}Count`);if(o&&n){const i=e[t+"s"]||0;n.textContent!==i.toString()&&(n.textContent=i,n.classList.add("highlight"),setTimeout((()=>n.classList.remove("highlight")),1e3)),clientIp&&e.reactions?.[t]?.[clientIp]?o.classList.add("active"):o.classList.remove("active")}}));const t=document.getElementById("commentsList");if(t&&e.comments){Array.from(t.querySelectorAll(".comment")).map((e=>e.dataset.commentId));if(e.comments.some((e=>{const o=t.querySelector(`[data-comment-id="${e.id}"]`);return!o||o&&e.deleted!==o.classList.contains("deleted")||o&&!e.deleted&&o.querySelector(".comment-content")?.textContent!==e.content}))){const o=e.comments.length>0?e.comments.map((e=>`\n                    <div class="comment ${e.deleted?"deleted":""}" data-comment-id="${e.id}">\n                        <div class="comment-header">\n                            <div class="comment-author">${e.author||"Anonymous"}</div>\n                            <div class="comment-date">${formatDateTime(e.created)}</div>\n                            ${e.deleted?'<div class="comment-deleted">This comment has been deleted by administrator</div>':`<div class="comment-content">${e.content}</div>`}\n                        </div>\n                        ${isAdmin&&!e.deleted?`<div class="comment-actions"><button onclick="deleteComment('${e.id}')"class="btn btn-danger btn-sm"><i class="fas fa-trash"></i>Delete</button></div>`:""}\n                    </div>\n                `)).join(""):'<div class="no-comments">No comments yet</div>';t.innerHTML=o}}}function deleteComment(e){showModal("Are you sure you want to delete this comment?","Confirm Delete","warning",`\n            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>\n            <button class="btn btn-danger" onclick="confirmDeleteComment('${e}')">Delete</button>\n        `)}function confirmDeleteComment(e){const t=getPostId();fetch(`${root_url}/api/posts/${t}/comments/${e}`,{method:"DELETE",credentials:"include"}).then((e=>{if(!e.ok)throw new Error("Failed to delete comment");return e.json()})).then((()=>{closeModal(),loadPost(),showModal("Comment deleted successfully","Success","success")})).catch((e=>{console.error("Delete error:",e),showModal("Failed to delete comment","Error","error")}))}function showModal(e,t="Notice",o="info",n=null){const i=document.getElementById("modal"),s=document.getElementById("modalTitle"),c=document.getElementById("modalMessage"),l=document.getElementById("modalIcon"),r=document.querySelector(".modal-buttons");let a="fa-info-circle";switch(o){case"error":a="fa-exclamation-circle";break;case"success":a="fa-check-circle";break;case"warning":a="fa-exclamation-triangle"}l.innerHTML=`<i class="fas ${a}"></i>`,l.className=`notification-icon ${o}`,s.textContent=t,c.textContent=e,r.innerHTML=n||'<button class="btn btn-primary" onclick="closeModal()">OK</button>',i.style.display="flex",i.onclick=function(e){e.target===i&&closeModal()},document.addEventListener("keydown",(function(e){"Escape"===e.key&&closeModal()}),{once:!0})}function closeModal(){document.getElementById("modal").style.display="none"}window.onload=function(){document.querySelectorAll(".admin-only").forEach((e=>{e.style.display="none"})),checkAuthStatus().then((()=>{getClientIp(),loadPost(),startPolling()}))},window.onbeforeunload=function(){isPolling=!1,pollTimeoutId&&clearTimeout(pollTimeoutId)};
